# 野火专业版IM服务集群测试
野火IM服务专业版支持集群部署，在集群部署时性能不是简单的资源集合，因为节点之间RPC需要消耗不少资源。本测试目的为测试出集群模式下野火的性能及得出集群性能估算方法。

为了简化测试，本测试使用单聊消息测试，其他类型操作可以基本类比。

## 环境准备
准备如下硬件资源：

| 用途 | 配置 | 数量 | 公网IP | 入访端口 | 出访端口 |
| ------ | ------ | ------ | ----- | ----- | ---- |
| IM服务 | 4C8G（腾讯云标准型S6） | 4 | 不需要 |  无（内网互通） |  无（内网互通） |
| MySQL数据库 | 8C16G（腾讯云mysql8 单节点） | 1 | 不需要 | 无（内网互通） |  无（内网互通） |
| 压测机 | 4C8G（腾讯云标准型S6） | 1 | 不需要 |  无（内网互通） |  无（内网互通） |

操作系统使用CentOS，其它Linux系统也行，不建议使用非Linux系统。

测试使用了4台IM服务，会分别测试单节点、2节点、3节点和4节点的情况。

此次测试主要为了测试集群能力，所以把mysql服务配置为最大IM服务的一半，避免数据库成为测试的瓶颈。

## 安装依赖工具
野火IM服务只依赖Java，CentOS使用下述命令安装，其它系统请自行查找方法。
```
yum install java-1.8.0-openjdk-headless.x86_64
```

## 部署IM服务
购买完云服务器后，就得到了云服务器的内网IP地址，选取其中一台的内网IP地址作为授权地址（后面做各种测试时，需要这台的IM服务一直在线），联系野火来获取此内网IP的试用软件包。把软件包上传到每台IM服务器，解压，然后做出如下配置：
1. ```config/wildfirechat.conf```
```
server.ip ip地址为当前节点的内网IP
#使用mysql数据库
embed.db 0
## 各种限频的大小改为1000000
http.admin.rate_limit 1000000
client.request_rate_limit 1000000
## 消息队列大小改为10万，这样当手机离线后发送10万条以内消息，上线后可以都收到。
message.max_queue 100000
## 下面这个配置默认是关掉的，需要打开
netty.epoll true

##节点ID，当集群部署时，一定不能有重复，可以给节点从1开始编号，1，2，3。。。。注意不能超过127。一定不能有重复，如果有稀奇古怪的问题请先检查nodeId是不是有重复
node_id 1

```
2. ```config/c3p0.xml```
正确添加数据库JDBC、用户名和密码。

3. ```bin/wildfirechat.sh```
```
JAVA_OPTS="$JAVA_OPTS -Xmx4G"
JAVA_OPTS="$JAVA_OPTS -Xms4G"
```

在每台IM服务上修改之后，就完成了单节点的配置，还需配置集群。集群配置如下：
1. ```config/wildfirechat.conf```
```
server.ip ip地址为当前节点的内网IP

##节点ID，从1开始编号，1，2，3，4。一定不能有重复。
node_id 1

```

2. ```config/hazelcast.xml```，关于网络部分，修改如下，其中4个member是4个节点的内网IP地址。
```
<network>
    <join>
        <multicast enabled="false"/>
        <tcp-ip enabled="true">
            <member>172.16.0.5</member>
            <member>172.16.0.9</member>
            <member>172.16.0.15</member>
            <member>172.16.0.16</member>
        </tcp-ip>
    </join>
</network>
```

我们测试的网络是内网互通的，客户测试时需要注意节点之间的网络是否放开，内网全部放开或者至少要放开5017端口的权限。

## 检查集群是否建立成功
在压测机上，执行命令
```
curl -v http://${授权地址}/api/version
```
返回的json文件中能看到 ```"nodeIds":"2 1 3 4"```， ```nodeIds```字段会显示当前集群的所有节点ID，如果包括了所有的节点ID就说明集群建立成功。

## 配置压测程序
在专业版IM服务软件包目录下有个```stress_test```目录，目录中有说明下载工具地址，下载测试工具到发送服务器，解压后得到一个可执行程序```wfcstress```和一个配置文件```config.toml```。

修改配置文件，只留下 ***IMConfig*** 和 ***TestSingleMessageConfig*** 配置项，其它都删除，然后配置如下:
```
# IM服务基础配置
[IMConfig]
## Host为专业版授权地址，如果其它地址测测试失败。
Host = "IM服务公网ip地址"
## 如果更改多客户端绑定端口，请把HttpPort改为定制的端口。
HttpPort = 80
AdminPort = 18080
AdminSecret = 123456
## Lite是否轻量模式，在lite为true时，压测工具只发送不会接收消息。如果测试聊天室功能请记得关闭此开关。
Lite = true
## 消息内容
## 较短文本消息内容，12个汉字，长度36B
MessageContent = "这是一个很短的文本内容！"


# 测试单聊消息。测试程序会创建SendUserCount个客户端并建立长链接。每个客户端循环给ReceiveUserCount个接收用户发送单聊消息。接收用户不会创建客户端。
[TestSingleMessageConfig]
## 是否开启此项测试
Enable = true
## 测试发送用户的前缀，用户ID为 ${SendUserPrefix}_i，SendUserPrefix U_ ，则用户ID为：U_0，U_1,U_2...。
## 用户的clientid为 用户id加上 c_, 比如c_U_0, c_U_1, c_U_2...。
SendUserPrefix = "U_"
## 发送消息用户数量，一般这个数字不要太大。
SendUserCount = 200
## 用户id的起始数，如果您有多台电脑，需要确保用户id不能重复。
SendUserStart = 0

## 客户端逐个给接收用户发送消息，此配置为发送消息的间隔，单位为毫秒。
SendMessageInterval = 0

## 目标用户的前缀，用户ID为 ${ReceiveUserPrefix}_i，ReceiveUserPrefix RU_ ，则用户ID为：RU_0，RU_1,RU_2...。注意不能和发送者前缀相同。
ReceiveUserPrefix = "RU_"
## 目标用户的数量。实际目标用户的总数量为ReceiveUserCount + WatchUserList.count。
ReceiveUserCount = 200
## 用户id的起始数，如果您有多台电脑，需要确保用户id不能重复。
ReceiveUserStart = 0
## 观察者的用户id，可以登陆一个或者多个手机客户端，观察消息发送情况。
WatchUserList = ["123456"]

## 是否跳过确认直接开始测试
SkipConfirm = true

## 循环次数。发送消息的总数为：SendUserCount * (ReceiveUserCount + WatchUserList.count) * Loop
Loop = 20
```
上述配置中，host要改为IM服务的授权地址，观察者用户id因为没有观察者，可以随便填一个，比如```123456```。测试一次发送的消息总数为 200 * (200 + 1) * 20 = 804000。

## 测试方案
为了验证集群效果和得出集群性能计算方法，测试分成4轮，第一轮测试单节点，后面每轮多加一个节点。

下一轮开始时先启动新加入的节点，然后等到3分钟，完成可能的节点之间的缓存迁移，然后再开始测试。

每一轮中测试2次，第一次测试作为热机，以第二次测试为准。每次测试之后等到3分钟，等到服务器load值下降到接近于零时才开始下一次测试。

因为发送消息较多，而内存相对较小，有可能会把IM服务压崩，此时需要修改IM服务的hazelcast.xml中的缓存配置，缩小缓存比例，或者重启节点。

## 发送消息测试
发送消息测试只发送消息，消息目标用户都不在线，测试消息发送能力。在发送服务器上执行：
```
nohup ./wfcstress 2>&1 &
tail -f nohup.out
```
正确情况下会看到先把200个发送者连接成功，等待3秒后就开始发送消息。等待压测程序执行完成后，观察：
1. 查看测试程序最后的输出，看看测试是否成功，看一下发送的条数和发送的时间，从而得出发送的速率。
2. 压测程序结束后10秒钟内，IM服务的CPU压力是否降为接近为0，查看测试过程中CPU的平均利用率和CPU利用率是否平稳。
3. 压测程序结束后10秒钟内，数据库的CPU压力是否降为接近为0，查看测试过程中CPU的平均利用率和CPU利用率是否平稳。

## 测试结果
IM服务CPU利用率基本上打满，消息都发送成功。数据如下：

| IM服务节点数| CPU核心数 | 发送条数 | 发送时长(秒) | 总体发送速率 | 单核发送速率 |
| ------ | ------ | ------ | ------ | ----- | --------- |
| 1 | 4 | 804000| 123 | 6537条/秒 | 1634条/秒 |
| 2 | 8 | 804000| 85 | 9459条/秒 | 1182条/秒 |
| 3 | 12 | 804000| 60 | 13400条/秒 | 1117条/秒 |
| 4 | 16 | 804000| 50 | 16080条/秒 | 1005条/秒 |

## 分析
用户是以一致性hash方式分散到各个节点上的，可以认为是平均分配。如果是单节点，所有用户都在同一个节点上；如果是2节点，那么每个节点都有一半的用户，发送消息就会有50%的消息要RPC处理；如果是3节点，每个节点都有三分之一的用户，发送消息就会有三分之二的消息要RPC处理；以此类推，4节点就是75%的消息要RPC。如果有非常多的节点，那么就接近于所有消息都要RPC处理。

对比单节点和2节点的单核性能，2节点的消息中有一半是本地处理，所以半核每秒处理800条，另外半核就是（1182 - 800）= 382，RPC的消息单核性能就是382*2 = 764，约等于800条，相当于单机性能的一半。

3节点时，三分之一的消息本地，三分之二的消息RPC，计算：```1600*0.3333 + 800*0.6667 = 1066```，接近于实际压测的结果 1117。

4节点时，25%的消息本地，75%的消息RPC，计算: ```1600*0.25 + 800*0.75 = 1000``` ，接近于实际压测的结果1005。

当部署非常多节点时，理论上消息都是RPC处理，性能趋向于 ```800``` 条/秒/核心。

系统整体能力方面，每增加一个节点，系统整体能力增加单机一半的能力。单机是```6537```条/秒，2节点就是```1.5*6537```，3节点就是```2*6537```，4节点就是```2.5*6537```，与测试结果基本吻合。

由于测试没有考虑数据库，所以测试结果还需要计算数据库的资源，一般IM服务和数据库的资源比例为2:1，所以大概可以得出，本地单核性能为 ```1600/1.5 = 1066```，RPC消息单核性能为 ```800/1.5 = 533```。

## 总结
野火IM集群扩展性得到验证，客户可以在腾讯云上重现此测试。当在线下测试时，可能远远达不到此结果，原因是腾讯云服务和数据库都是经过最优化处理的，当出现严重偏离时，需要客户来进行优化服务器和数据库，排除系统瓶颈。
